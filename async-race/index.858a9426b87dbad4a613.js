(()=>{"use strict";const t=class{constructor(t,e){this.container=document.createElement(t),this.container.className=e}async render(){return this.container}},e=class extends t{getElementTemplate(){return'\n      <div class="header__container container">\n        <button class="header__btn header__btn_active btn" type="button" id="toGarage" data-section="garage">\n        </button>\n        <button class="header__btn btn" type="button" id="toWinner" data-section="winners"></button>\n      </div>\n    '}async addListeners(){const t=this.container.querySelectorAll(".header__btn"),e=document.querySelectorAll("section");t.forEach((n=>{n.addEventListener("click",(n=>{n.preventDefault(),t.forEach((t=>t.classList.remove("header__btn_active")));const a=n.target;a.classList.toggle("header__btn_active"),e.forEach((t=>t.classList.remove("active")));const s=a.dataset.section;s&&document.getElementById(s)?.classList.add("active")}))}))}async render(){const t=this.getElementTemplate();return this.container.innerHTML=t,this.container}},n="http://127.0.0.1:3000",a={garage:`${n}/garage`,engine:`${n}/engine`,winners:`${n}/winners`},s={},i=async t=>(await fetch(`${a.garage}/${t}`)).json();function r(t){const{top:e,left:n,width:a,height:s}=t.getBoundingClientRect();return{x:n+a/2,y:e+s/2}}const c=class{constructor(t){this.color=t}getElementTemplate(){return`\n      <svg version="1.2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 696 236" width="70" height="24">\n        <path fill="${this.color}"\n          d="m683.3 193.3q-0.1 0-0.2 0h-37.1c-7.3 24.7-30.1 42.7-57.1 42.7-27.1 0-49.9-18-57.1-42.7h-349.1c-7.2 24.7-30.1 42.7-57.1 42.7-27 0-49.8-18-57.1-42.7h-39.5c-10.2 0-18.6-7.9-19.2-18l-2.5-37.2q0-0.9 0-1.8 0-1 0.1-1.9 0.2-0.9 0.4-1.8 0.2-0.9 0.5-1.8l9.6-29.2-5-27.2c-1.1-5.9 2.6-11.7 8.4-13.3l14.1-3.7-6.5-24.5-5.5-0.8c-14.8-2-25.1-15.6-23.1-30.3q0.1-0.4 0.3-0.8 0.2-0.3 0.5-0.6 0.4-0.2 0.8-0.3 0.4-0.1 0.8-0.1l36.2 5c14.7 2 25 15.6 23 30.3q-0.1 0.4-0.3 0.8-0.2 0.3-0.5 0.6-0.3 0.2-0.7 0.4-0.4 0.1-0.8 0l-14.4-2 5 18.4c28.4-7.2 57.2-13.4 86.1-18.4 29-5 58.1-8.9 87.4-11.6 29.2-2.8 58.5-4.3 87.9-4.8 29.4-0.4 58.8 0.3 88.1 2.2q2.5 0.1 5 0.4 2.4 0.3 4.9 0.7 2.5 0.4 4.9 1 2.4 0.5 4.8 1.1 2.4 0.7 4.8 1.5 2.4 0.7 4.7 1.6 2.3 0.9 4.6 1.9 2.3 1 4.5 2.1l90.2 45.4q3 1.5 6.2 2.8 3.1 1.4 6.3 2.5 3.2 1 6.5 1.9 3.2 0.9 6.6 1.6l83.1 16.1q4.9 1 9.5 2.9 4.6 1.8 8.8 4.5 4.2 2.7 7.9 6.1 3.6 3.4 6.5 7.4l13.7 18.9c1.9 0.8 3.6 1.8 5.2 3 1.6 1.2 2.9 2.7 4 4.4 1.2 1.6 2 3.4 2.6 5.3 0.6 1.9 0.9 3.9 0.9 5.9v14.5c0 2-0.3 4-0.9 5.9-0.5 1.9-1.4 3.8-2.5 5.4-1.1 1.7-2.5 3.2-4 4.5-1.6 1.2-3.3 2.3-5.2 3.1zm-624.5-72.5l-3.8-9.9q-0.2-0.4-0.4-0.8-0.3-0.4-0.6-0.7-0.4-0.4-0.8-0.6-0.4-0.2-0.8-0.4l-16.8-5.8q-0.9-0.3-1.8-0.2-0.9 0.1-1.7 0.5-0.8 0.5-1.4 1.2-0.5 0.7-0.7 1.6l-3.9 15c-0.6 2.7 1.4 5.3 4.1 5.4l24.5 0.7c3.1 0 5.3-3.1 4.1-6zm32.1 55.7q0 2.2 0.3 4.4 0.3 2.2 0.9 4.3 0.5 2.1 1.3 4.2 0.8 2 1.9 3.9c5.9 10.7 17.3 17.9 30.3 17.9 13 0 24.4-7.2 30.3-17.9q1.1-1.9 1.9-3.9 0.8-2.1 1.4-4.2 0.5-2.1 0.8-4.3 0.3-2.2 0.3-4.4c0-19.1-15.6-34.7-34.7-34.7-19.1 0-34.7 15.6-34.7 34.7zm112.9-132.8l-37.4 5.4q-3.4 0.5-6.7 1.6-3.3 1.1-6.3 2.8-3 1.8-5.6 4-2.7 2.3-4.8 5c-1.7 2.1-0.1 5.2 2.6 5l32.6-2.1q4-0.2 7.9-1.4 3.8-1.1 7.3-3 3.5-1.9 6.5-4.6 3.1-2.6 5.4-5.8l1.5-2c1.6-2.2-0.3-5.2-3-4.9zm17.7 73.7l11.5 30.6q1.4 3.7 3.6 7.1 2.2 3.3 5 6.1 2.9 2.8 6.3 4.9 3.4 2.2 7.2 3.5l2.3 0.8c2.6 0.9 4.9-1.8 3.8-4.3l-16.1-34.2q-1.4-3.1-3.5-6-2-2.8-4.5-5.1-2.6-2.4-5.5-4.2-2.9-1.9-6.1-3.2c-2.5-1-5 1.5-4 4zm295.6-18.6h-0.1l-90.2-45.4q-3.4-1.7-6.9-3-3.5-1.3-7.1-2.3-3.6-1-7.3-1.6-3.7-0.6-7.4-0.8-8.7-0.6-17.4-1-8.8-0.4-17.5-0.7-8.7-0.3-17.5-0.4-8.7-0.2-17.5-0.2-28 0-56.1 1.5-2.7 0.1-5.3 0.7-2.7 0.6-5.2 1.6-2.5 1-4.9 2.4-2.3 1.4-4.3 3.2c-15.6 13.5-31.3 29.6-29.8 38.9 2.9 17.2 266.6 19.7 285 19.8q0.2 0 0.5 0 0.2 0 0.5-0.1 0.2 0 0.5-0.1 0.2 0 0.4-0.1l7.2-2.9c4.1-1.6 4.4-7.4 0.4-9.5zm71.8 43c-19.1 0-34.7 15.6-34.7 34.7q0 2.2 0.3 4.4 0.3 2.2 0.8 4.3 0.6 2.1 1.4 4.2 0.8 2 1.9 3.9c5.9 10.7 17.2 17.9 30.3 17.9 13 0 24.4-7.2 30.3-17.9q1.1-1.9 1.9-3.9 0.8-2.1 1.3-4.2 0.6-2.1 0.9-4.3 0.2-2.2 0.2-4.4c0-19.1-15.5-34.7-34.6-34.7zm74.1-2.4l-14.2-17.8q-0.1-0.1-0.2-0.2-0.2-0.1-0.3-0.2-0.1 0-0.3-0.1-0.1 0-0.3-0.1l-31.5-5.3c-1.7-0.3-2.6 1.9-1.2 2.9l22.6 17.2q0.1 0.1 0.1 0.1 0.1 0.1 0.2 0.1 0 0 0.1 0.1 0.1 0 0.2 0l23.1 6c1.6 0.4 2.7-1.4 1.7-2.7z" />\n        <path fill="#e6e6fa"\n          d="m588.9 163.4c7.2 0 13 5.9 13 13.1 0 7.2-5.8 13.1-13 13.1-7.3 0-13.1-5.9-13.1-13.1 0-7.2 5.8-13.1 13.1-13.1zm-463.3 0c7.3 0 13.1 5.9 13.1 13.1 0 7.2-5.8 13.1-13.1 13.1-7.2 0-13.1-5.9-13.1-13.1 0-7.2 5.9-13.1 13.1-13.1z" />\n      </svg>\n    `}},o=class extends t{constructor(t,e,n){super(t,e),this.container.id=n,this.cars=[],this.carsCount="0",this.curentPage=1}async getGarageData(){const t=await(async(t=1,e=7)=>{const n=await fetch(`${a.garage}?_page=${t}&_limit=${e}`);return{cars:await n.json(),carsCount:n.headers.get("X-Total-Count")??"0"}})(this.curentPage);this.cars=t.cars,this.carsCount=t.carsCount}async addListeners(){const t=this.container.querySelector("#create"),e=this.container.querySelector("#update"),n=this.container.querySelector(".garage__icon-race"),s=this.container.querySelector(".garage__icon-reset"),i=this.container.querySelector(".garage__page_prev"),r=this.container.querySelector(".garage__page_next"),c=this.container.querySelectorAll(".car__btn_delete"),o=this.container.querySelectorAll(".car__btn_custom"),d=this.container.querySelectorAll(".car__btn_start"),l=this.container.querySelectorAll(".car__btn_stop"),h=this.container.querySelector(".garage__result");t?.addEventListener("submit",(async e=>{e.preventDefault();const n=t.input.value,s=t.color.value;if(n&&s){const t={name:n,color:s};await(async t=>(await fetch(a.garage,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}})).json())(t),this.reRender()}})),e?.addEventListener("submit",(async t=>{t.preventDefault();const n=e.dataset.id,s=e.input.value,i=e.color.value;if(s&&i&&n){const t={name:s,color:i};await(async(t,e)=>(await fetch(`${a.garage}/${t}`,{method:"PUT",body:JSON.stringify(e),headers:{"Content-Type":"application/json"}})).json())(+n,t),this.reRender()}})),c.forEach((t=>{t.addEventListener("click",(async t=>{t.preventDefault();const e=t.target.dataset.id;if(e){await(async t=>(await fetch(`${a.garage}/${t}`,{method:"DELETE"})).json())(+e),await(async t=>(await fetch(`${a.winners}/${t}`,{method:"DELETE"})).json())(+e);const t=document.querySelector(".winners__update"),n=new Event("click");t.dispatchEvent(n),this.reRender()}}))})),o.forEach((n=>{n.addEventListener("click",(async n=>{n.preventDefault();const a=n.target;a.style.color="#7afeff";const s=a.dataset.id;t.input.disabled=!0,t.color.disabled=!0,t.btn.disabled=!0,e.dataset.id=s,e.input.disabled=!1,e.input.value="nissan",e.color.disabled=!1,e.btn.disabled=!1}))})),d.forEach((t=>{t.addEventListener("click",(async t=>{t.preventDefault();const e=t.target.dataset.id;e&&this.startMoving(+e)}))})),l.forEach((t=>{t.addEventListener("click",(async t=>{t.preventDefault();const e=t.target.dataset.id;e&&this.stopMoving(+e)}))})),n.addEventListener("click",(async t=>{t.preventDefault(),n.disabled=!0;let e=[];e=this.cars.map((t=>this.startMoving(t.id)));const i=this.cars.map((t=>t.id));try{const t=await this.raceAll(e,i);t.id&&t.time&&(h.textContent=`Best result: ${t.name} - ${t.time}`,await(async(t,e)=>{if(404===await(async t=>(await fetch(`${a.winners}/${t}`)).status)(t))await(async t=>(await fetch(a.winners,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}})).json())({id:t,wins:1,time:e});else{const n=await(async t=>{try{const e=await fetch(`${a.winners}/${t}`);return await e.json()}catch{throw new Error("Ошибка")}})(t);await(async(t,e)=>(await fetch(`${a.winners}/${t}`,{method:"PUT",body:JSON.stringify(e),headers:{"Content-Type":"application/json"}})).json())(t,{id:t,wins:+n.wins+1,time:e<+n.time?e:n.time})}})(t.id,+t.time));const n=document.querySelector(".winners__update"),r=new Event("click");n.dispatchEvent(r),s.disabled=!1}catch(t){alert("All engines were broken."),s.disabled=!1}})),s.addEventListener("click",(async t=>{t.preventDefault(),this.cars.map((t=>this.stopMoving(t.id))),s.disabled=!0,setTimeout((()=>{h.textContent="",n.disabled=!1}),1200)})),i.addEventListener("click",(t=>{t.preventDefault(),this.curentPage--,this.reRender()})),r.addEventListener("click",(t=>{t.preventDefault(),this.curentPage++,this.reRender()}))}async raceAll(t,e){const{success:n,carId:a,time:s}=await Promise.any(t);if(!n){const n=e.findIndex((t=>t===a)),s=[...t.slice(0,n),...t.slice(n+1,t.length)],i=[...e.slice(0,n),...e.slice(n+1,e.length)];return this.raceAll(s,i)}return{...this.cars.find((t=>t.id===a)),time:(+s/1e3).toFixed(3)}}async startMoving(t){const e=document.getElementById(`btn-start-${t}`),n=document.getElementById(`btn-stop-${t}`);e.disabled=!0;const{velocity:i,distance:c}=await(async t=>(await fetch(`${a.engine}?id=${t}&status=started`,{method:"PATCH"})).json())(t);n.disabled=!1;const o=Math.round(c/i),d=document.getElementById(`car-${t}`),l=document.getElementById(`finish-${t}`),h=Math.floor(function(t,e){const n=r(t),a=r(e);return Math.hypot(n.x-a.x,n.y-a.y)}(d,l))-38;s[t]=function(t,e,n){let a=null;const s={};return s.id=window.requestAnimationFrame((function i(r){a||(a=r);const c=r-a,o=Math.round(c*(e/n));t.style.transform=`translateX(${Math.min(o,e)}px)`,o<e&&(s.id=window.requestAnimationFrame(i))})),s}(d,h,o);const{success:u}=await(async t=>{const e=await fetch(`${a.engine}?id=${t}&status=drive`,{method:"PATCH"}).catch();return 200!==e.status?{success:!1}:{...await e.json()}})(t);return u||window.cancelAnimationFrame(s[t].id),{success:u,carId:t,time:o}}async stopMoving(t){document.getElementById(`btn-stop-${t}`).disabled=!0,await(async t=>(await fetch(`${a.engine}?id=${t}&status=stopped`,{method:"PATCH"})).json())(t),document.getElementById(`btn-start-${t}`).disabled=!1,document.getElementById(`car-${t}`).style.transform="translateX(0)",s[t]&&window.cancelAnimationFrame(s[t].id)}getCarItems(){return this.cars.map((t=>new class{constructor(t,e,n){this.name=t,this.color=e,this.id=n,this.icon=new c(this.color)}getElementTemplate(){return`\n    <li class="garage__item">\n      <div class="car" id="${this.id}">\n        <div class="car__controls">\n          <button class="car__btn car__btn_start btn" type="button" id="btn-start-${this.id}" \n          data-id=${this.id}>\n          </button>\n          <button class="car__btn car__btn_stop btn" type="button" id="btn-stop-${this.id}" \n          data-id=${this.id} disabled>\n          </button>\n          <span class="car__name">${this.name}</span>\n          <button class="car__btn car__btn_custom btn" type="button" data-id="${this.id}">Customize</button>\n          <button class="car__btn car__btn_delete btn" type="button" data-id="${this.id}">Delete</button>\n        </div>\n        <div class="car__race">\n          <div class="car__ride" id="car-${this.id}">\n            ${this.icon.getElementTemplate()}\n          </div>\n          <div class="car__track"></div>\n          <span class="car__finish" id="finish-${this.id}"></span>\n        </div>\n      </div>\n    </li>\n    `}render(){return this.getElementTemplate()}}(t.name,t.color,t.id).render())).join("")}isPrevPageBtnDisable(){return this.curentPage<=1?"disabled":""}isNextPageBtnDisable(){return 7*this.curentPage>=+this.carsCount?"disabled":""}getElementTemplate(){return`\n      <div class="garage__manipulation">\n        <div class="garage__icon"></div>\n        <div class="garage__manipulation-controls">\n          <form class="garage__control" id="create">\n            <input class="garage__input" type="text" name="input">\n            <input class="garage__input" type="color" name="color" value="#2962e3">\n            <button class=" garage__btn btn" name="btn" type="submit">Create</button>\n          </form>\n          <form class="garage__control" id="update">\n            <input class="garage__input" type="text" name="input" disabled>\n            <input class="garage__input" type="color" name="color" disabled>\n            <button class="garage__btn btn" type="submit" name="btn" disabled>Customize</button>\n          </form>\n        </div>\n        <button class="garage__icon garage__icon-race btn"></button>\n        <button class="garage__icon garage__icon-reset btn" disabled></button>\n      </div>\n      <h1 class="garage__title">Cars in garage (${this.carsCount}) <span class="garage__result"></span></h1>\n      <ul class="garage__list">\n         ${this.getCarItems()}\n      </ul>\n      <div class="garage__pages">\n        <button class="garage__page garage__page_prev" type="button" ${this.isPrevPageBtnDisable()}></button>\n        <span class="garage__current-page">Page #${this.curentPage}</span>\n        <button class="garage__page garage__page_next" type="button" ${this.isNextPageBtnDisable()}></button>\n      </div>\n    `}async render(){await this.getGarageData();const t=this.getElementTemplate();return this.container.innerHTML=t,this.container}async reRender(){await this.getGarageData();const t=this.getElementTemplate();this.container.innerHTML=t,this.addListeners()}},d=class extends t{constructor(t,e,n){super(t,e),this.container.id=n,this.winners=[],this.winnersCount="0",this.curentPage=1}async getGarageData(){const t=await(async(t=1,e=10,n="wins",s="DESC")=>{const r=await fetch(`${a.winners}?_page=${t}&_limit=${e}&_sort=${n}&_order=${s}`),c=await r.json(),o=r.headers.get("X-Total-Count")??"0";return{items:await Promise.all(c.map((async t=>({...t,car:await i(t.id)})))),count:o}})(this.curentPage);this.winners=t.items,this.winnersCount=t.count}getWinnerRow(){return this.winners.map(((t,e)=>new class{constructor(t,e,n,a,s){this.id=t+1,this.wins=e,this.time=n,this.color=a??"#000",this.name=s??"Car",this.icon=new c(this.color)}getElementTemplate(){return`\n      <tr class="winners__table-row">\n        <td>${this.id}</td>\n        <td>${this.icon.getElementTemplate()}</td>\n        <td>${this.name}</td>\n        <td>${this.wins}</td>\n        <td>${this.time}</td>\n      </tr>\n    `}render(){return this.getElementTemplate()}}(e,t.wins,t.time,t.car?.color,t.car?.name).render())).join("")}isPrevPageBtnDisable(){return this.curentPage<=1?"disabled":""}isNextPageBtnDisable(){return 10*this.curentPage>=+this.winnersCount?"disabled":""}getElementTemplate(){return`\n      <h1 class="winners__title">Winners (${this.winnersCount})</h1>\n      <div class="winners__content"">\n        <table class="winners__table">\n          <tr class="winners__table-header">\n            <th>#</th>\n            <th>Car</th>\n            <th>Name</th>\n            <th>Wins</th>\n            <th>Best time</th>\n          </tr>\n          ${this.getWinnerRow()}\n        </table>\n      </div>\n      <button class="winners__update btn"></button>\n      <div class="winners__pages">\n        <button class="winners__page winners__page_prev" type="button" ${this.isPrevPageBtnDisable()}></button>\n        <span class="winners__current-page">Page #${this.curentPage}</span>\n        <button class="winners__page winners__page_next" type="button" ${this.isNextPageBtnDisable()}></button>\n      </div>\n    `}async addListeners(){const t=this.container.querySelector(".winners__update"),e=this.container.querySelector(".winners__page_prev"),n=this.container.querySelector(".winners__page_next");t.addEventListener("click",(t=>{t.preventDefault(),this.reRender()})),e.addEventListener("click",(t=>{t.preventDefault(),this.curentPage--,this.reRender()})),n.addEventListener("click",(t=>{t.preventDefault(),this.curentPage++,this.reRender()}))}async render(){await this.getGarageData();const t=this.getElementTemplate();return this.container.innerHTML=t,this.container}async reRender(){await this.getGarageData();const t=this.getElementTemplate();this.container.innerHTML=t,this.addListeners()}},l=class extends t{constructor(t,e){super(t,e),this.garage=new o("section","garage active","garage"),this.winners=new d("section","winners","winners")}async getContentNode(){const t=document.createElement("div");return t.className="content__container container",t.append(await this.garage.render()),t.append(await this.winners.render()),t}async addListeners(){await this.garage.addListeners(),await this.winners.addListeners()}async render(){return this.container.append(await this.getContentNode()),this.container}},h=class extends t{getElementTemplate(){return'\n      <div class="footer__container container">\n        <span class="footer__info">© 2023</span>\n        <a class="footer__link" href="https://github.com/vadim-m" target="_blank">@vadim-m</a>\n        <a class="footer__link" href="https://rs.school/js/" target="_blank">RS School</a>\n      </div>\n    '}async render(){const t=this.getElementTemplate();return this.container.innerHTML=t,this.container}};(new class{constructor(){this.page=new class{constructor(){this.header=new e("header","header"),this.main=new l("main","content"),this.footer=new h("footer","footer")}async listen(){await this.header.addListeners(),await this.main.addListeners()}async render(){document.body.append(await this.header.render()),document.body.append(await this.main.render()),document.body.append(await this.footer.render())}}}async run(){await this.page.render(),await this.page.listen()}}).run(),console.log("\nДрузья, спасибо всем, кто дал время доделать.\nМожет еще что успею допилить до вечера четверга.\nСамооценка - 155, что точно не работает:\n\n1. Нет генерации рандомных 100 машин - минус 10 баллов\n2. Анимация на экране 500рх не очень выглядит - минус 15 баллов\n(может успею поправить адативом еще)\n3. Нет сортировки таблицы победителей - минус 10 баллов\n\nОшибки запросов в консоли типа GET,DELETE и 404 как я понял норма для таска.\nОстальное на ваше усмотрение. Если что - пишите!\nМой дискорд @Vadim_M#0673.\n")})();